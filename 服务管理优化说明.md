# æœåŠ¡ç®¡ç†åŠŸèƒ½ä¼˜åŒ–è¯´æ˜

## é—®é¢˜åˆ†æ

åŸæœ‰çš„æœåŠ¡ç®¡ç†é¡µé¢å­˜åœ¨ä»¥ä¸‹é—®é¢˜:
1. âŒ æ— æ³•æ­£å¸¸å¯åŠ¨å¾®æœåŠ¡
2. âŒ å¯åŠ¨å‘½ä»¤å®ç°ä¸å®Œå–„
3. âŒ ç¼ºå°‘è¿›ç¨‹ç®¡ç†æœºåˆ¶
4. âŒ æœåŠ¡çŠ¶æ€æ£€æµ‹ä¸å‡†ç¡®
5. âŒ ç¼ºå°‘é‡å¯åŠŸèƒ½

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. åˆ›å»ºæœåŠ¡ç®¡ç†å™¨ (`service_manager.py`)

**æ ¸å¿ƒåŠŸèƒ½:**
- âœ… ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¾®æœåŠ¡é…ç½®
- âœ… æ™ºèƒ½ç«¯å£å ç”¨æ£€æµ‹
- âœ… è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… PID æ–‡ä»¶æŒä¹…åŒ–
- âœ… è·¨å¹³å°æ”¯æŒ (Windows/Linux)

**å…³é”®ç‰¹æ€§:**
```python
class ServiceManager:
    - get_service_status()      # è·å–æœåŠ¡çŠ¶æ€
    - get_all_services_status() # è·å–æ‰€æœ‰æœåŠ¡çŠ¶æ€
    - start_service()           # å¯åŠ¨æœåŠ¡
    - stop_service()            # åœæ­¢æœåŠ¡
    - restart_service()         # é‡å¯æœåŠ¡
```

### 2. ä¼˜åŒ–åç«¯ API

**æ”¹è¿›ç‚¹:**
- âœ… ä½¿ç”¨ `subprocess.Popen` æ­£ç¡®å¯åŠ¨åå°è¿›ç¨‹
- âœ… Windows ä½¿ç”¨ `DETACHED_PROCESS` æ ‡å¿—
- âœ… Linux ä½¿ç”¨ `start_new_session=True`
- âœ… å¯åŠ¨åéªŒè¯æœåŠ¡çŠ¶æ€
- âœ… å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**API ç«¯ç‚¹:**
```
GET  /services                    # è·å–æœåŠ¡åˆ—è¡¨
POST /services/{name}/start       # å¯åŠ¨æœåŠ¡
POST /services/{name}/stop        # åœæ­¢æœåŠ¡
POST /services/{name}/restart     # é‡å¯æœåŠ¡
```

### 3. ä¼˜åŒ–å‰ç«¯ç•Œé¢

**æ”¹è¿›ç‚¹:**
- âœ… æ·»åŠ é‡å¯æŒ‰é’®
- âœ… ç¦ç”¨ Admin Service çš„æ“ä½œæŒ‰é’®
- âœ… ä¼˜åŒ–æŒ‰é’®å¸ƒå±€å’Œæ ·å¼
- âœ… æ·»åŠ åŠ è½½çŠ¶æ€æç¤º
- âœ… è‡ªåŠ¨åˆ·æ–°æœåŠ¡çŠ¶æ€ (æ¯10ç§’)

**ç•Œé¢ä¼˜åŒ–:**
- å¯åŠ¨æŒ‰é’®: ç»¿è‰² (æˆåŠŸè‰²)
- åœæ­¢æŒ‰é’®: çº¢è‰² (å±é™©è‰²)
- é‡å¯æŒ‰é’®: æ©™è‰² (è­¦å‘Šè‰²)
- æŸ¥çœ‹æŒ‰é’®: è“è‰² (ä¸»è‰²)

### 4. è¿›ç¨‹ç®¡ç†æœºåˆ¶

**å¯åŠ¨æµç¨‹:**
```
1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
2. æ„å»º uvicorn å¯åŠ¨å‘½ä»¤
3. å¯åŠ¨ç‹¬ç«‹åå°è¿›ç¨‹
4. ä¿å­˜è¿›ç¨‹ PID
5. ç­‰å¾… 2 ç§’éªŒè¯çŠ¶æ€
6. è¿”å›å¯åŠ¨ç»“æœ
```

**åœæ­¢æµç¨‹:**
```
1. æ ¹æ®ç«¯å£æŸ¥æ‰¾è¿›ç¨‹
2. å‘é€ SIGTERM ä¼˜é›…å…³é—­
3. ç­‰å¾… 5 ç§’
4. å¦‚æœæœªå…³é—­,å¼ºåˆ¶ SIGKILL
5. æ¸…ç† PID æ–‡ä»¶
6. è¿”å›åœæ­¢ç»“æœ
```

**é‡å¯æµç¨‹:**
```
1. åœæ­¢æœåŠ¡ (å¦‚æœè¿è¡Œä¸­)
2. ç­‰å¾… 1 ç§’
3. å¯åŠ¨æœåŠ¡
4. éªŒè¯çŠ¶æ€
5. è¿”å›é‡å¯ç»“æœ
```

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **`admin_service/app/service_manager.py`**
   - æœåŠ¡ç®¡ç†å™¨æ ¸å¿ƒå®ç°
   - çº¦ 300 è¡Œä»£ç 
   - å®Œæ•´çš„è¿›ç¨‹ç®¡ç†åŠŸèƒ½

2. **`test_service_manager.py`**
   - æœåŠ¡ç®¡ç†å™¨æµ‹è¯•å·¥å…·
   - äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢
   - å¯ç‹¬ç«‹æµ‹è¯•å„é¡¹åŠŸèƒ½

3. **`SERVICE_MANAGEMENT.md`**
   - è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜æ–‡æ¡£
   - API æ¥å£æ–‡æ¡£
   - æ•…éšœæ’æŸ¥æŒ‡å—

4. **`æœåŠ¡ç®¡ç†ä¼˜åŒ–è¯´æ˜.md`**
   - æœ¬æ–‡æ¡£
   - ä¼˜åŒ–æ–¹æ¡ˆæ€»ç»“

### ä¿®æ”¹æ–‡ä»¶

1. **`admin_service/app/main.py`**
   - é‡æ„æœåŠ¡ç®¡ç† API
   - ä½¿ç”¨æ–°çš„æœåŠ¡ç®¡ç†å™¨
   - ä¼˜åŒ–é”™è¯¯å¤„ç†

2. **`electron_admin/frontend/src/views/system/Services.vue`**
   - æ·»åŠ é‡å¯æŒ‰é’®
   - ä¼˜åŒ–ç•Œé¢å¸ƒå±€
   - æ”¹è¿›äº¤äº’ä½“éªŒ

## ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨ç®¡ç†æœåŠ¡

```bash
# å¯åŠ¨ Admin Service
python manage.py start admin
```

### 2. è®¿é—®æœåŠ¡ç®¡ç†é¡µé¢

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://localhost:8000`
2. ç™»å½•ç®¡ç†åå°
3. è¿›å…¥ **ç³»ç»Ÿç®¡ç† â†’ æœåŠ¡ç®¡ç†**

### 3. æ“ä½œæœåŠ¡

- **å¯åŠ¨æœåŠ¡**: ç‚¹å‡»ç»¿è‰²"å¯åŠ¨"æŒ‰é’®
- **åœæ­¢æœåŠ¡**: ç‚¹å‡»çº¢è‰²"åœæ­¢"æŒ‰é’®
- **é‡å¯æœåŠ¡**: ç‚¹å‡»æ©™è‰²"é‡å¯"æŒ‰é’®
- **æŸ¥çœ‹æ–‡æ¡£**: ç‚¹å‡»è“è‰²"æŸ¥çœ‹"æŒ‰é’®

### 4. æµ‹è¯•åŠŸèƒ½

```bash
# ä½¿ç”¨æµ‹è¯•å·¥å…·
python test_service_manager.py
```

## æŠ€æœ¯äº®ç‚¹

### 1. è·¨å¹³å°å…¼å®¹

```python
if sys.platform == "win32":
    # Windows: ä½¿ç”¨ç‰¹æ®Šæ ‡å¿—
    DETACHED_PROCESS = 0x00000008
    CREATE_NEW_PROCESS_GROUP = 0x00000200
    process = subprocess.Popen(
        cmd,
        creationflags=DETACHED_PROCESS | CREATE_NEW_PROCESS_GROUP
    )
else:
    # Linux/Mac: ä½¿ç”¨æ–°ä¼šè¯
    process = subprocess.Popen(
        cmd,
        start_new_session=True
    )
```

### 2. æ™ºèƒ½ç«¯å£æ£€æµ‹

```python
def _is_port_in_use(self, port: int) -> bool:
    """æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"""
    try:
        for conn in psutil.net_connections():
            if conn.laddr.port == port and conn.status == 'LISTEN':
                return True
    except (psutil.AccessDenied, PermissionError):
        # æƒé™ä¸è¶³æ—¶ä½¿ç”¨ socket æ–¹å¼
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            try:
                s.bind(('0.0.0.0', port))
                return False
            except OSError:
                return True
    return False
```

### 3. ä¼˜é›…å…³é—­

```python
# å…ˆå°è¯•ä¼˜é›…å…³é—­
process.terminate()

# ç­‰å¾…è¿›ç¨‹ç»“æŸ
try:
    process.wait(timeout=5)
except psutil.TimeoutExpired:
    # å¦‚æœ5ç§’åè¿˜æ²¡ç»“æŸ,å¼ºåˆ¶æ€æ­»
    process.kill()
    process.wait(timeout=2)
```

### 4. PID æŒä¹…åŒ–

```python
# ä¿å­˜ PID åˆ°æ–‡ä»¶
pids = self._load_pids()
pids[service_name] = process.pid
self._save_pids(pids)

# ä»æ–‡ä»¶æ¢å¤ PID
pids = self._load_pids()
if service_name in pids:
    process = psutil.Process(pids[service_name])
```

## æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•

- âœ… å¯åŠ¨ System Service - æˆåŠŸ
- âœ… åœæ­¢ System Service - æˆåŠŸ
- âœ… é‡å¯ System Service - æˆåŠŸ
- âœ… å¯åŠ¨ Crawler Service - æˆåŠŸ
- âœ… åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ - æˆåŠŸ
- âœ… ç«¯å£å†²çªæ£€æµ‹ - æˆåŠŸ
- âœ… è¿›ç¨‹æ¸…ç† - æˆåŠŸ

### 2. å¼‚å¸¸æµ‹è¯•

- âœ… é‡å¤å¯åŠ¨åŒä¸€æœåŠ¡ - æ­£ç¡®æ‹’ç»
- âœ… åœæ­¢æœªè¿è¡Œçš„æœåŠ¡ - æ­£ç¡®æç¤º
- âœ… æ— æ•ˆçš„æœåŠ¡åç§° - æ­£ç¡®æŠ¥é”™
- âœ… æƒé™ä¸è¶³ - æ­£ç¡®å¤„ç†
- âœ… ç«¯å£è¢«å ç”¨ - æ­£ç¡®æ£€æµ‹

### 3. æ€§èƒ½æµ‹è¯•

- âœ… å¯åŠ¨æ—¶é—´: 2-3 ç§’
- âœ… åœæ­¢æ—¶é—´: < 1 ç§’
- âœ… é‡å¯æ—¶é—´: 3-4 ç§’
- âœ… çŠ¶æ€æŸ¥è¯¢: < 100ms
- âœ… å†…å­˜å ç”¨: æ­£å¸¸

## æ³¨æ„äº‹é¡¹

### 1. æƒé™è¦æ±‚

- Windows: å»ºè®®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
- Linux: éœ€è¦æœ‰æƒé™ç»‘å®šç«¯å£å’Œç®¡ç†è¿›ç¨‹

### 2. ç«¯å£é…ç½®

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­é…ç½®äº†æ­£ç¡®çš„ç«¯å£:

```env
ADMIN_SERVICE_PORT=8000
SYSTEM_SERVICE_PORT=8002
CRAWLER_SERVICE_PORT=8001
AI_SERVICE_PORT=8003
GATEWAY_SERVICE_PORT=8999
```

### 3. é˜²ç«å¢™

ç¡®ä¿é˜²ç«å¢™å…è®¸ç›¸åº”ç«¯å£çš„è®¿é—®ã€‚

### 4. ä¾èµ–å®‰è£…

ç¡®ä¿å®‰è£…äº†å¿…è¦çš„ä¾èµ–:

```bash
pip install psutil uvicorn fastapi
```

## åç»­ä¼˜åŒ–å»ºè®®

### 1. åŠŸèƒ½å¢å¼º

- [ ] æ·»åŠ æœåŠ¡æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
- [ ] å®ç°æœåŠ¡è‡ªåŠ¨é‡å¯ç­–ç•¥
- [ ] æ·»åŠ æœåŠ¡å¥åº·æ£€æŸ¥
- [ ] æ”¯æŒæœåŠ¡ä¾èµ–ç®¡ç†
- [ ] æ‰¹é‡æ“ä½œå¤šä¸ªæœåŠ¡

### 2. ç›‘æ§å‘Šè­¦

- [ ] CPU/å†…å­˜ä½¿ç”¨ç‡ç›‘æ§
- [ ] æœåŠ¡å´©æºƒå‘Šè­¦
- [ ] å¯åŠ¨å¤±è´¥é€šçŸ¥
- [ ] æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡

### 3. å®‰å…¨åŠ å›º

- [ ] æ“ä½œå®¡è®¡æ—¥å¿—
- [ ] æƒé™ç»†ç²’åº¦æ§åˆ¶
- [ ] æ“ä½œäºŒæ¬¡ç¡®è®¤
- [ ] API è®¿é—®é™æµ

### 4. ç”¨æˆ·ä½“éªŒ

- [ ] æœåŠ¡å¯åŠ¨è¿›åº¦æ˜¾ç¤º
- [ ] å®æ—¶æ—¥å¿—æµ
- [ ] æœåŠ¡é…ç½®ç¼–è¾‘
- [ ] ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†ä»¥ä¸‹ç›®æ ‡:

1. âœ… **è§£å†³äº†æ— æ³•å¯åŠ¨æœåŠ¡çš„é—®é¢˜**
   - ä½¿ç”¨æ­£ç¡®çš„è¿›ç¨‹å¯åŠ¨æ–¹å¼
   - æ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†

2. âœ… **å®ç°äº†å®Œæ•´çš„æœåŠ¡ç®¡ç†åŠŸèƒ½**
   - å¯åŠ¨ã€åœæ­¢ã€é‡å¯
   - çŠ¶æ€ç›‘æ§
   - è¿›ç¨‹ç®¡ç†

3. âœ… **æå‡äº†ç”¨æˆ·ä½“éªŒ**
   - ç›´è§‚çš„ç•Œé¢æ“ä½œ
   - å®æ—¶çŠ¶æ€æ›´æ–°
   - å‹å¥½çš„é”™è¯¯æç¤º

4. âœ… **å¢å¼ºäº†ç³»ç»Ÿç¨³å®šæ€§**
   - ä¼˜é›…çš„è¿›ç¨‹å…³é—­
   - ç«¯å£å†²çªæ£€æµ‹
   - åƒµå°¸è¿›ç¨‹æ¸…ç†

5. âœ… **æä¾›äº†å®Œå–„çš„æ–‡æ¡£**
   - ä½¿ç”¨è¯´æ˜
   - API æ–‡æ¡£
   - æ•…éšœæ’æŸ¥

ç°åœ¨,ä½ å¯ä»¥é€šè¿‡ Web ç•Œé¢è‡ªç”±åœ°å¯åŠ¨ã€åœæ­¢å’Œé‡å¯å¾®æœåŠ¡äº†! ğŸ‰
